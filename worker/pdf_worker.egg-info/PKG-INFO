Metadata-Version: 2.4
Name: pdf-worker
Version: 0.1.0
Summary: PDF processing worker for ML extraction
Requires-Python: >=3.13
Description-Content-Type: text/markdown
Requires-Dist: psycopg[binary]>=3.2
Requires-Dist: sqlalchemy>=2.0
Requires-Dist: pdfplumber>=0.11
Requires-Dist: spacy>=3.8
Requires-Dist: pydantic>=2.0
Requires-Dist: pydantic-settings>=2.0
Requires-Dist: structlog>=24.1
Provides-Extra: dev
Requires-Dist: pytest>=8.0; extra == "dev"
Requires-Dist: pytest-asyncio>=0.23; extra == "dev"
Requires-Dist: pytest-cov>=4.0; extra == "dev"
Requires-Dist: testcontainers>=4.0; extra == "dev"
Requires-Dist: ruff>=0.8; extra == "dev"
Requires-Dist: mypy>=1.0; extra == "dev"

# PDF Processing Worker

Isolated service that polls `pdf_jobs`, extracts text from PDFs, runs a spaCy-based ML pipeline, and writes `ml_raw_result` and `ml_normalized_result` to the database.

## Requirements

- Python 3.13+
- PostgreSQL 18.x (shared with Laravel app)
- Local storage path for uploaded PDFs (e.g. Laravel `storage/app/uploaded_documents`)

## Environment variables

| Variable | Description | Default |
|----------|-------------|---------|
| `DB_HOST` | PostgreSQL host | `localhost` |
| `DB_PORT` | PostgreSQL port | `5432` |
| `DB_NAME` | Database name | `bioreport` |
| `DB_USER` | Database user | `postgres` |
| `DB_PASSWORD` | Database password | (required) |
| `POLL_INTERVAL_SECONDS` | Seconds between polls when no job | `5` |
| `MAX_ATTEMPTS` | Max attempts before marking job failed | `3` |
| `STORAGE_BASE_PATH` | Base path for PDF files (local disk) | `/data/uploaded_documents` |
| `SPACY_MODEL_NAME` | spaCy model to load | `en_core_web_sm` |

## Local development

1. Create a virtualenv and install:

   ```bash
   cd worker
   python -m venv .venv
   source .venv/bin/activate   # or .venv\Scripts\activate on Windows
   pip install -e ".[dev]"
   python -m spacy download en_core_web_sm
   ```

2. Copy `.env.example` to `.env` and set `DB_*` and `STORAGE_BASE_PATH` (e.g. path to Laravel `storage/app/uploaded_documents`).

3. Run the worker:

   ```bash
   python -m app.main
   ```

4. Lint and type-check:

   ```bash
   ruff check app tests
   mypy app
   ```

5. Tests:

   ```bash
   pytest
   ```

## Docker

Build and run with Docker Compose (uses `.env` from project root or `worker/`):

```bash
cd worker
docker compose build
docker compose up -d pdf-worker
```

Mount the Laravel uploaded documents directory so the worker can read PDFs:

- Set `UPLOADED_DOCUMENTS_PATH` in `.env` to the host path (e.g. `../storage/app/uploaded_documents`).
- The service mounts it at `/data/uploaded_documents`; set `STORAGE_BASE_PATH=/data/uploaded_documents` (default).

No ports are exposed; the worker only talks to PostgreSQL and the mounted volume.

## Behaviour

- Polls `pdf_jobs` for `status = 'pending'`.
- Locks one row with `FOR UPDATE SKIP LOCKED`, sets `status = 'processing'`, increments `attempts`, sets `locked_at`.
- Loads the corresponding row from `uploaded_documents`, resolves the PDF path (`STORAGE_BASE_PATH / user_id / uuid.pdf`).
- Extracts text with pdfplumber (text-based PDFs only). Empty or unreadable PDFs are failed or requeued.
- Runs the spaCy pipeline to produce `ml_raw_result`; normalizes to `ml_normalized_result`.
- Updates `uploaded_documents` (`ml_raw_result`, `ml_normalized_result`, `processed_at`) and `pdf_jobs` (`status = 'done'`).
- On error: if `attempts >= MAX_ATTEMPTS` then `status = 'failed'` and `error_message`; otherwise the job is requeued (`status = 'pending'`).
- Handles SIGTERM and exits after the current job (if any).
